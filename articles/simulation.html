<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Demonstrating EcoState via simulation â€¢ EcoState</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Demonstrating EcoState via simulation">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">EcoState</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/eastern_bering_sea.html">Eastern Bering Sea case study</a></li>
    <li><a class="dropdown-item" href="../articles/simulation.html">Demonstrating EcoState via simulation</a></li>
    <li><a class="dropdown-item" href="../articles/surplus_production.html">EcoState as surplus production model</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/James-Thorson-NOAA/EcoState/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Demonstrating EcoState via simulation</h1>
                        <h4 data-toc-skip class="author">James
Thorson</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/James-Thorson-NOAA/EcoState/blob/HEAD/vignettes/simulation.Rmd" class="external-link"><code>vignettes/simulation.Rmd</code></a></small>
      <div class="d-none name"><code>simulation.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://james-thorson-noaa.github.io/EcoState/" class="external-link">EcoState</a></span><span class="op">)</span></span></code></pre></div>
<p><code>ecostate</code> is an R package for fitting the mass-balance
dynamics specified by EcoSim as a state-space model. We here highlight a
few features in particular.</p>
<div class="section level2">
<h2 id="simulation-demonstration">Simulation demonstration<a class="anchor" aria-label="anchor" href="#simulation-demonstration"></a>
</h2>
<p>We first simulate new data. To do so, we specify a 5-species
ecosystem:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Time-interval</span></span>
<span><span class="va">years</span> <span class="op">=</span> <span class="fl">1981</span><span class="op">:</span><span class="fl">2020</span></span>
<span><span class="va">n_years</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">years</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Name taxa (optional, for illustration)</span></span>
<span><span class="va">taxa</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Consumer_1"</span>, <span class="st">"Consumer_2"</span>, <span class="st">"Predator_1"</span>, <span class="st">"Predator_2"</span>, <span class="st">"Producer"</span>, <span class="st">"Detritus"</span><span class="op">)</span></span>
<span><span class="va">n_species</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">taxa</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Ecopath-with-EcoSim parameters</span></span>
<span><span class="co"># Diet matrix</span></span>
<span><span class="va">DC_ij</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="fl">0</span>,     <span class="fl">0</span>,     <span class="fl">0.8</span>,  <span class="fl">0.4</span>,  <span class="fl">0</span>,   <span class="fl">0</span>,</span>
<span>  <span class="fl">0</span>,     <span class="fl">0</span>,     <span class="fl">0.2</span>,  <span class="fl">0.6</span>,  <span class="fl">0</span>,   <span class="fl">0</span>,</span>
<span>  <span class="fl">0</span>,     <span class="fl">0</span>,     <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span>,   <span class="fl">0</span>,</span>
<span>  <span class="fl">0</span>,     <span class="fl">0</span>,     <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span>,   <span class="fl">0</span>,</span>
<span>  <span class="fl">0.9</span>,   <span class="fl">0.3</span>,   <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span>,   <span class="fl">0</span>,</span>
<span>  <span class="fl">0.1</span>,   <span class="fl">0.7</span>,   <span class="fl">0</span>,    <span class="fl">0</span>,    <span class="fl">0</span>,   <span class="fl">0</span></span>
<span><span class="op">)</span>, byrow<span class="op">=</span><span class="cn">TRUE</span>, ncol<span class="op">=</span><span class="va">n_species</span><span class="op">)</span></span>
<span><span class="va">PB_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">4</span>, <span class="fl">1</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">90</span>, <span class="fl">0.5</span> <span class="op">)</span>         <span class="co"># Reciprocal of mean age according to Polovina-1984 ~= M</span></span>
<span><span class="va">QB_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">10</span>, <span class="fl">4</span>, <span class="fl">3</span>, <span class="fl">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span><span class="va">EE_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0.9</span>, <span class="fl">0.9</span>, <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">0.9</span>, <span class="fl">0.9</span> <span class="op">)</span></span>
<span><span class="va">B_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="cn">NA</span>, <span class="cn">NA</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="cn">NA</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span><span class="va">U_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="fl">0.2</span>, <span class="va">n_species</span> <span class="op">)</span></span>
<span><span class="va">type_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="st">"hetero"</span>, <span class="st">"hetero"</span>, <span class="st">"hetero"</span>, <span class="st">"hetero"</span>, <span class="st">"auto"</span>, <span class="st">"detritus"</span> <span class="op">)</span></span>
<span><span class="va">which_primary</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">type_i</span><span class="op">==</span><span class="st">"auto"</span><span class="op">)</span></span>
<span><span class="va">which_detritus</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">type_i</span><span class="op">==</span><span class="st">"detritus"</span><span class="op">)</span></span>
<span><span class="va">X_ij</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span> <span class="fl">2</span>, nrow<span class="op">=</span><span class="va">n_species</span>, ncol<span class="op">=</span><span class="va">n_species</span> <span class="op">)</span></span>
<span><span class="va">X_ij</span><span class="op">[</span>,<span class="va">which_primary</span><span class="op">]</span> <span class="op">=</span> <span class="fl">91</span></span></code></pre></div>
<p>We first define a function that simulates data, using the same
functions for mass-balance and simulating dynamics are then used by
EcoState during parameter estimation:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">simulate_data</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="co"># Simulate process errors</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">101</span><span class="op">)</span></span>
<span>  <span class="va">rarray</span> <span class="op">=</span> \<span class="op">(</span><span class="va">x</span>,<span class="va">dims</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,<span class="va">sd</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="va">sd</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html" class="external-link">prod</a></span><span class="op">(</span><span class="va">dims</span><span class="op">)</span><span class="op">)</span>, dim<span class="op">=</span><span class="va">dims</span> <span class="op">)</span></span>
<span>  <span class="va">epsilon_ti</span> <span class="op">=</span> <span class="fu">rarray</span><span class="op">(</span>dims<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_years</span>,<span class="va">n_species</span><span class="op">)</span>,sd<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_years</span><span class="op">)</span>,<span class="va">sigmaB_i</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Choose method to integrate instantaneous rates for annual dynamics</span></span>
<span>  <span class="va">n_steps</span> <span class="op">=</span> <span class="fl">10</span></span>
<span>  <span class="va">project_vars</span> <span class="op">=</span> <span class="va">abm3pc_sys</span></span>
<span>  </span>
<span>  <span class="co"># Define parameters</span></span>
<span>  <span class="va">Pars</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> logB_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span> <span class="va">B_i</span> <span class="op">)</span>, </span>
<span>                     logPB_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">PB_i</span><span class="op">)</span>,</span>
<span>                     logQB_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">QB_i</span><span class="op">)</span>,</span>
<span>                     Xprime_ij <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">X_ij</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                     EE_i <span class="op">=</span> <span class="va">EE_i</span>,</span>
<span>                     DC_ij <span class="op">=</span> <span class="va">DC_ij</span>,</span>
<span>                     U_i <span class="op">=</span> <span class="va">U_i</span>,</span>
<span>                     type_i <span class="op">=</span> <span class="va">type_i</span>,</span>
<span>                     noB_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">B_i</span><span class="op">)</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span>,</span>
<span>                     epsilon_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">n_species</span><span class="op">)</span>,</span>
<span>                     logF_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>,<span class="va">n_species</span><span class="op">)</span>,</span>
<span>                     which_primary <span class="op">=</span> <span class="va">which_primary</span>,</span>
<span>                     which_detritus <span class="op">=</span> <span class="va">which_detritus</span>,</span>
<span>                     F_type <span class="op">=</span> <span class="st">"integrated"</span> <span class="op">)</span></span>
<span>  <span class="va">Pars_full</span> <span class="op">=</span> <span class="fu"><a href="../reference/add_equilibrium.html">add_equilibrium</a></span><span class="op">(</span> <span class="va">Pars</span>,</span>
<span>                               scale_solver <span class="op">=</span> <span class="st">"joint"</span>,</span>
<span>                               noB_i <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">Pars</span><span class="op">$</span><span class="va">logB_i</span><span class="op">)</span>,<span class="fl">1</span>,<span class="fl">0</span><span class="op">)</span>,</span>
<span>                               type_i <span class="op">=</span> <span class="va">type_i</span> <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Project forward</span></span>
<span>  <span class="va">Bobs_ti</span> <span class="op">=</span> <span class="va">Cobs_ti</span> <span class="op">=</span> <span class="va">B_ti</span> <span class="op">=</span> <span class="va">C_ti</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span> <span class="cn">NA</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">n_years</span>,<span class="va">n_species</span><span class="op">)</span>, </span>
<span>                                    dimnames<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Year"</span><span class="op">=</span><span class="va">years</span>,<span class="st">"Taxon"</span><span class="op">=</span><span class="va">taxa</span><span class="op">)</span> <span class="op">)</span></span>
<span>  <span class="va">B_ti</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">Pars_full</span><span class="op">$</span><span class="va">logB_i</span><span class="op">)</span></span>
<span>  <span class="va">C_ti</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span></span>
<span>  </span>
<span>  <span class="kw">for</span><span class="op">(</span> <span class="va">t</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">years</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">)</span><span class="op">{</span></span>
<span>    <span class="co"># Fishing mortality ramps up for two predators</span></span>
<span>    <span class="va">F_t</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0</span>, <span class="fl">0</span>, <span class="va">t</span><span class="op">/</span><span class="va">n_years</span><span class="op">*</span><span class="fl">0.2</span>, <span class="va">t</span><span class="op">/</span><span class="va">n_years</span><span class="op">*</span><span class="fl">0.1</span>, <span class="fl">0</span>, <span class="fl">0</span> <span class="op">)</span></span>
<span>  </span>
<span>    <span class="co">#</span></span>
<span>    <span class="va">pars_t</span> <span class="op">=</span> <span class="va">Pars_full</span></span>
<span>    <span class="va">pars_t</span><span class="op">$</span><span class="va">logF_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">F_t</span><span class="op">)</span></span>
<span>    <span class="va">pars_t</span><span class="op">$</span><span class="va">epsilon_i</span> <span class="op">=</span> <span class="va">epsilon_ti</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span></span>
<span>    </span>
<span>    <span class="co"># Integrate dynamics annually</span></span>
<span>    <span class="va">data2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">local</a></span><span class="op">(</span><span class="op">{</span></span>
<span>                    <span class="va">n_species</span> <span class="op">=</span> <span class="va">n_species</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">environment</a></span><span class="op">(</span><span class="va">dBdt</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">data2</span></span>
<span>    <span class="va">sim</span> <span class="op">=</span> <span class="fu">project_vars</span><span class="op">(</span></span>
<span>          f <span class="op">=</span> <span class="va">dBdt</span>,</span>
<span>          a <span class="op">=</span> <span class="va">years</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, </span>
<span>          b <span class="op">=</span> <span class="va">years</span><span class="op">[</span><span class="va">t</span><span class="op">]</span>,</span>
<span>          n <span class="op">=</span> <span class="va">n_steps</span>,</span>
<span>          Pars <span class="op">=</span> <span class="va">pars_t</span>,</span>
<span>          y0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="va">B_ti</span><span class="op">[</span><span class="va">t</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="va">n_species</span><span class="op">)</span> <span class="op">)</span> <span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># Record results</span></span>
<span>    <span class="va">B_ti</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_species</span><span class="op">)</span><span class="op">]</span></span>
<span>    <span class="va">C_ti</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">sim</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,<span class="va">n_species</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n_species</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>    <span class="co"># Simulate measurement errors</span></span>
<span>    <span class="va">Bobs_ti</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span> <span class="op">=</span> <span class="va">B_ti</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_species</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">Cobs_ti</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">C_ti</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span><span class="op">==</span><span class="fl">0</span>,<span class="cn">NA</span>,<span class="va">C_ti</span><span class="op">[</span><span class="va">t</span>,<span class="op">]</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n_species</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span> <span class="st">"B_ti"</span><span class="op">=</span><span class="va">B_ti</span>, <span class="st">"C_ti"</span><span class="op">=</span><span class="va">C_ti</span>, <span class="st">"Bobs_ti"</span><span class="op">=</span><span class="va">Bobs_ti</span>, </span>
<span>                <span class="st">"Cobs_ti"</span><span class="op">=</span><span class="va">Cobs_ti</span>, <span class="st">"Pars_full"</span><span class="op">=</span><span class="va">Pars_full</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="comparison-with-rpath">Comparison with Rpath<a class="anchor" aria-label="anchor" href="#comparison-with-rpath"></a>
</h2>
<p>We first compare the functions used by EcoState with existing
implementations of the model. One script-based implementation available
in R is Rpath, and we therefore show the syntax and model-output for
this comparison. For this comparison, we first simulate a data set that
does not have any process errors:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sigmaB_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span> <span class="co"># Taxa 1-2 crashes solver if sigmaB &gt; 0.02</span></span>
<span><span class="va">sim</span> <span class="op">=</span> <span class="fu">simulate_data</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>We then load <code>Rpath</code> and reformat inputs in the format
that it expects to calculate mass-balance:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/NOAA-EDAB/Rpath" class="external-link">Rpath</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rpath needs types in ascending order (EcoState doesn't care)</span></span>
<span><span class="va">types</span>  <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">type_i</span>,<span class="st">"fishery"</span><span class="op">)</span>, FUN<span class="op">=</span><span class="va">switch</span>, </span>
<span>                  <span class="st">"hetero"</span><span class="op">==</span><span class="fl">0</span>, <span class="st">"auto"</span><span class="op">=</span><span class="fl">1</span>, <span class="st">"detritus"</span><span class="op">=</span><span class="fl">2</span>, <span class="st">"fishery"</span><span class="op">=</span><span class="fl">3</span> <span class="op">)</span></span>
<span><span class="va">groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="va">taxa</span>, <span class="st">"fishery"</span> <span class="op">)</span></span>
<span><span class="va">stgroups</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">groups</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="va">REco.params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Rpath/man/create.rpath.params.html" class="external-link">create.rpath.params</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">groups</span>, type <span class="op">=</span> <span class="va">types</span>, stgroup <span class="op">=</span> <span class="va">stgroups</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fill in biomass</span></span>
<span><span class="co">#REco.params$model$Biomass = c( exp(Pars_full$logB_i), NA )</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">Biomass</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="va">B_i</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">EE</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">type_i</span><span class="op">==</span><span class="st">"detritus"</span>,<span class="cn">NA</span>,<span class="va">EE_i</span><span class="op">)</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">PB</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="va">PB_i</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">QB</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="va">QB_i</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#Biomass accumulation and unassimilated consumption</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">BioAcc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">taxa</span><span class="op">)</span><span class="op">)</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">Unassim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">type_i</span><span class="op">==</span><span class="st">"hetero"</span>,<span class="fl">0.2</span>,<span class="fl">0</span><span class="op">)</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#Detrital Fate</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">Detritus</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">type_i</span><span class="op">==</span><span class="st">"detritus"</span>,<span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span>, <span class="fl">0</span> <span class="op">)</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">fishery</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">taxa</span><span class="op">)</span><span class="op">)</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">model</span><span class="op">$</span><span class="va">fishery.disc</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">taxa</span><span class="op">)</span><span class="op">)</span>, <span class="cn">NA</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Diet</span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span> <span class="va">REco.params</span><span class="op">$</span><span class="va">diet</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">taxa</span><span class="op">)</span>,<span class="va">j</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="va">DC_ij</span><span class="op">[</span>,<span class="va">j</span><span class="op">]</span></span>
<span><span class="va">REco.params</span><span class="op">$</span><span class="va">diet</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">taxa</span><span class="op">)</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">=</span> <span class="va">DC_ij</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span></span>
<span><span class="co"># Balance using Ecopath equations</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/Rpath/man/check.rpath.params.html" class="external-link">check.rpath.params</a></span><span class="op">(</span> <span class="va">REco.params</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rpath parameter file is functional.</span></span>
<span><span class="va">REco</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Rpath/man/rpath.html" class="external-link">rpath</a></span><span class="op">(</span><span class="va">REco.params</span>, eco.name <span class="op">=</span> <span class="st">'R Ecosystem'</span><span class="op">)</span></span></code></pre></div>
<p>We can then simulate forward in time using Rpath:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create simulation object</span></span>
<span><span class="va">REco.sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Rpath/man/rsim.scenario.html" class="external-link">rsim.scenario</a></span><span class="op">(</span><span class="va">REco</span>, <span class="va">REco.params</span>, years <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#</span></span>
<span><span class="va">REco.sim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Rpath/man/adjust.fishing.html" class="external-link">adjust.fishing</a></span><span class="op">(</span> Rsim.scenario<span class="op">=</span><span class="va">REco.sim</span>, </span>
<span>                           parameter<span class="op">=</span><span class="st">'ForcedFRate'</span>, </span>
<span>                           group <span class="op">=</span> <span class="st">'Predator_1'</span>, <span class="co"># Group is which species to apply</span></span>
<span>                           sim.year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span>, </span>
<span>                           sim.month <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                           value <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">40</span><span class="op">/</span><span class="fl">40</span><span class="op">)</span><span class="op">*</span><span class="fl">0.2</span> <span class="op">)</span></span>
<span><span class="va">REco.sim</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/Rpath/man/adjust.fishing.html" class="external-link">adjust.fishing</a></span><span class="op">(</span> Rsim.scenario<span class="op">=</span><span class="va">REco.sim</span>, </span>
<span>                           parameter<span class="op">=</span><span class="st">'ForcedFRate'</span>, </span>
<span>                           group <span class="op">=</span> <span class="st">'Predator_2'</span>, <span class="co"># Group is which species to apply</span></span>
<span>                           sim.year <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span>, </span>
<span>                           sim.month <span class="op">=</span> <span class="fl">0</span>, </span>
<span>                           value <span class="op">=</span> <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">40</span><span class="op">/</span><span class="fl">40</span><span class="op">)</span><span class="op">*</span><span class="fl">0.1</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Match vulnerability for self-limitation in Producers</span></span>
<span><span class="va">REco.sim</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">VV</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">REco.sim</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">PreyFrom</span><span class="op">==</span><span class="fl">0</span> <span class="op">&amp;</span> <span class="va">REco.sim</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">PreyTo</span><span class="op">==</span><span class="fl">5</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">91</span></span>
<span></span>
<span><span class="co"># </span></span>
<span><span class="va">REco.run1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/Rpath/man/rsim.run.html" class="external-link">rsim.run</a></span><span class="op">(</span><span class="va">REco.sim</span>, method <span class="op">=</span> <span class="st">'RK4'</span>, years <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">40</span><span class="op">)</span></span></code></pre></div>
<p>Comparing the scenario forecasted with Rpath against the simulated
time-series, we see that the two closely match. EcoState uses the same
functions during fitting, and so it also closely matches Rpath.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calculate annual simulated catch</span></span>
<span><span class="va">Year</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span> <span class="va">years</span>, each<span class="op">=</span><span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">Bsim_ti</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span> <span class="va">REco.run1</span><span class="op">$</span><span class="va">out_Biomass</span><span class="op">[</span>,<span class="op">-</span><span class="fl">1</span><span class="op">]</span>, MARGIN<span class="op">=</span><span class="fl">2</span>, FUN<span class="op">=</span>\<span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">x</span>,INDEX<span class="op">=</span><span class="va">Year</span>,FUN<span class="op">=</span><span class="va">mean</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co">#</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">)</span>, mar<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>,<span class="fl">3</span>,<span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span>, mgp<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">0.5</span>,<span class="fl">0</span><span class="op">)</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">years</span>, y<span class="op">=</span><span class="va">Bsim_ti</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_years</span><span class="op">)</span>,<span class="va">Bsim_ti</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>, </span>
<span>         type<span class="op">=</span><span class="st">"l"</span>, lwd<span class="op">=</span><span class="fl">3</span>, lty<span class="op">=</span><span class="st">"solid"</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="va">n_species</span><span class="op">)</span>, log<span class="op">=</span><span class="st">"y"</span>,</span>
<span>         ylab<span class="op">=</span><span class="st">"Relative biomass (Rpath)"</span>, xlab<span class="op">=</span><span class="st">"Year"</span> <span class="op">)</span></span>
<span><span class="va">Brel_ti</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">B_ti</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_years</span><span class="op">)</span>,<span class="va">sim</span><span class="op">$</span><span class="va">B_ti</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">years</span>, y<span class="op">=</span><span class="va">sim</span><span class="op">$</span><span class="va">B_ti</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_years</span><span class="op">)</span>,<span class="va">sim</span><span class="op">$</span><span class="va">B_ti</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>, </span>
<span>         type<span class="op">=</span><span class="st">"l"</span>, lwd<span class="op">=</span><span class="fl">3</span>, lty<span class="op">=</span><span class="st">"solid"</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="va">n_species</span><span class="op">)</span>, log<span class="op">=</span><span class="st">"y"</span>,</span>
<span>         ylab<span class="op">=</span><span class="st">"Relative biomass (Simulated)"</span>, xlab<span class="op">=</span><span class="st">"Year"</span> <span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"bottomleft"</span>, fill<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="va">n_species</span><span class="op">)</span>, legend<span class="op">=</span><span class="va">taxa</span>, ncol<span class="op">=</span><span class="fl">2</span>, bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-7-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="fitting-the-model-using-ecostate">Fitting the model using EcoState<a class="anchor" aria-label="anchor" href="#fitting-the-model-using-ecostate"></a>
</h2>
<p>We next want to show how EcoState performs when fitting to simulated
data. We simulate a data set that has process errors, and plot it to
compare with the previous simulation that did not have process
errors:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Simulate new data</span></span>
<span><span class="va">sigmaB_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.02</span>, <span class="fl">0.02</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="co"># Taxa 1-2 crashes solver if sigmaB &gt; 0.02</span></span>
<span><span class="va">sim</span> <span class="op">=</span> <span class="fu">simulate_data</span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Unload simulated data</span></span>
<span><span class="va">Bobs_ti</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">Bobs_ti</span></span>
<span><span class="va">Cobs_ti</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">Cobs_ti</span></span>
<span><span class="va">B_ti</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">B_ti</span></span>
<span><span class="va">Pars_full</span> <span class="op">=</span> <span class="va">sim</span><span class="op">$</span><span class="va">Pars_full</span></span>
<span></span>
<span><span class="co"># Plot simulation with process errors</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/matplot.html" class="external-link">matplot</a></span><span class="op">(</span> x<span class="op">=</span><span class="va">years</span>, y<span class="op">=</span><span class="va">B_ti</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>,<span class="va">n_years</span><span class="op">)</span>,<span class="va">B_ti</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span><span class="op">)</span>, </span>
<span>         type<span class="op">=</span><span class="st">"l"</span>, lwd<span class="op">=</span><span class="fl">3</span>, lty<span class="op">=</span><span class="st">"solid"</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grDevices/palettes.html" class="external-link">rainbow</a></span><span class="op">(</span><span class="va">n_species</span><span class="op">)</span>, log<span class="op">=</span><span class="st">"y"</span>,</span>
<span>         ylab<span class="op">=</span><span class="st">"Relative biomass (simulated)"</span>, xlab<span class="op">=</span><span class="st">"Year"</span> <span class="op">)</span></span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-8-1.png" width="672"></p>
<p>We then reformat simulated biomass and catch time-series into
long-form data frames and fit them with <code>ecostate</code></p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reformat to longform data-frame</span></span>
<span><span class="va">Catch</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">Cobs_ti</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Mass"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">Cobs_ti</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">Biomass</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">Bobs_ti</span><span class="op">)</span><span class="op">)</span>, <span class="st">"Mass"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">Bobs_ti</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Settings: specify what parameters to estimate</span></span>
<span><span class="va">fit_eps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Producer"</span>, <span class="st">"Detritus"</span>, <span class="st">"Predator_1"</span>, <span class="st">"Predator_2"</span><span class="op">)</span>   <span class="co"># process errors</span></span>
<span><span class="va">fit_Q</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>       <span class="co"># catchability coefficient</span></span>
<span><span class="va">fit_B0</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">)</span>      <span class="co"># non-equilibrium initial condition</span></span>
<span><span class="va">fit_B</span> <span class="op">=</span> <span class="va">taxa</span>       <span class="co"># equilibrium biomass</span></span>
<span></span>
<span><span class="co"># Solving for EE and giving uninformed initial values for biomass</span></span>
<span><span class="va">fittedB_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">Pars_full</span><span class="op">$</span><span class="va">logB_i</span><span class="op">)</span></span>
<span><span class="va">fittedEE_i</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">n_species</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Label EwE inputs for each taxon as expected (so users can easily change taxa)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">PB_i</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">QB_i</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fittedB_i</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">fittedEE_i</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">type_i</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">U_i</span><span class="op">)</span> <span class="op">=</span> <span class="va">taxa</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">DC_ij</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">X_ij</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Prey"</span><span class="op">=</span><span class="va">taxa</span>, <span class="st">"Predator"</span><span class="op">=</span><span class="va">taxa</span><span class="op">)</span></span>
<span>  </span>
<span><span class="co"># Run model</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="../reference/ecostate.html">ecostate</a></span><span class="op">(</span> taxa <span class="op">=</span> <span class="va">taxa</span>,</span>
<span>                years <span class="op">=</span> <span class="va">years</span>,</span>
<span>                catch <span class="op">=</span> <span class="va">Catch</span>,</span>
<span>                biomass <span class="op">=</span> <span class="va">Biomass</span>,</span>
<span>                PB <span class="op">=</span> <span class="va">PB_i</span>,</span>
<span>                QB <span class="op">=</span> <span class="va">QB_i</span>,</span>
<span>                DC <span class="op">=</span> <span class="va">DC_ij</span>,</span>
<span>                B <span class="op">=</span> <span class="va">fittedB_i</span>,</span>
<span>                EE <span class="op">=</span> <span class="va">fittedEE_i</span>,</span>
<span>                X <span class="op">=</span> <span class="va">X_ij</span>,</span>
<span>                type <span class="op">=</span> <span class="va">type_i</span>,</span>
<span>                U <span class="op">=</span> <span class="va">U_i</span>,</span>
<span>                fit_B <span class="op">=</span> <span class="va">fit_B</span>,</span>
<span>                fit_Q <span class="op">=</span> <span class="va">fit_Q</span>,</span>
<span>                fit_eps <span class="op">=</span> <span class="va">fit_eps</span>,</span>
<span>                fit_B0 <span class="op">=</span> <span class="va">fit_B0</span>,</span>
<span>                control <span class="op">=</span> <span class="fu"><a href="../reference/ecostate_control.html">ecostate_control</a></span><span class="op">(</span> inverse_method <span class="op">=</span> <span class="st">"Standard"</span>, </span>
<span>                                            trace <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                            nlminb_loops <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                            tmbad.sparse_hessian_compress <span class="op">=</span> <span class="fl">0</span>,  <span class="co"># Much faster to turn off</span></span>
<span>                                            getsd <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                            process_error <span class="op">=</span> <span class="st">"epsilon"</span>,  <span class="co"># alpha is faster than epsilon</span></span>
<span>                                            profile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logF_ti"</span>,<span class="st">"logB_i"</span><span class="op">)</span>,</span>
<span>                                            start_tau <span class="op">=</span> <span class="fl">0.001</span> <span class="op">)</span><span class="op">)</span>   </span>
<span><span class="co">#&gt;   0:    -175.67951: -6.90776 -6.90776 -6.90776 -6.90776</span></span>
<span><span class="co">#&gt;   1:    -176.09205: -6.45547 -6.65726 -6.90774 -6.87630</span></span>
<span><span class="co">#&gt;   2:    -194.07887: -4.51446 -5.93490 -6.90771 -6.81779</span></span>
<span><span class="co">#&gt;   3:    -231.52565: -2.28383 -5.79723 -6.90771 -6.81528</span></span>
<span><span class="co">#&gt;   4:    -246.17855: -2.53994 -3.58688 -6.90762 -6.60686</span></span>
<span><span class="co">#&gt;   5:    -254.85582: -2.53612 -2.37286 -6.90751 -6.60556</span></span>
<span><span class="co">#&gt;   6:    -255.08065: -2.44978 -2.45820 -6.90751 -6.60496</span></span>
<span><span class="co">#&gt;   7:    -255.08182: -2.45253 -2.57374 -6.90753 -6.56779</span></span>
<span><span class="co">#&gt;   8:    -255.10439: -2.43108 -2.51739 -6.90752 -6.57478</span></span>
<span><span class="co">#&gt;   9:    -255.10608: -2.44549 -2.51686 -6.90752 -6.57398</span></span>
<span><span class="co">#&gt;  10:    -255.10628: -2.44407 -2.51297 -6.90753 -6.56015</span></span>
<span><span class="co">#&gt;  11:    -255.10681: -2.44004 -2.51405 -6.90754 -6.52541</span></span>
<span><span class="co">#&gt;  12:    -255.10898: -2.43522 -2.51301 -6.90758 -6.38555</span></span>
<span><span class="co">#&gt;  13:    -255.97851: -2.37578 -2.49770 -6.90821 -4.14722</span></span>
<span><span class="co">#&gt;  14:    -258.84048: -2.39224 -2.49867 -6.90845 -3.25170</span></span>
<span><span class="co">#&gt;  15:    -262.20225: -2.43521 -2.51084 -6.90862 -2.45701</span></span>
<span><span class="co">#&gt;  16:    -262.56510: -2.41559 -2.57204 -6.90862 -2.24141</span></span>
<span><span class="co">#&gt;  17:    -262.57940: -2.43126 -2.58874 -6.90862 -2.21391</span></span>
<span><span class="co">#&gt;  18:    -262.58100: -2.41829 -2.60958 -6.90862 -2.18788</span></span>
<span><span class="co">#&gt;  19:    -262.58231: -2.42628 -2.60835 -6.90862 -2.19131</span></span>
<span><span class="co">#&gt;  20:    -262.58237: -2.42845 -2.60079 -6.90863 -2.19523</span></span>
<span><span class="co">#&gt;  21:    -262.58248: -2.42698 -2.60414 -6.90863 -2.19646</span></span>
<span><span class="co">#&gt;  22:    -262.58249: -2.42756 -2.60460 -6.90863 -2.19634</span></span>
<span><span class="co">#&gt;  23:    -262.58249: -2.42748 -2.60529 -6.90863 -2.19606</span></span>
<span><span class="co">#&gt;  24:    -262.58249: -2.42753 -2.60524 -6.90863 -2.19605</span></span>
<span><span class="co">#&gt;  25:    -262.58249: -2.42753 -2.60520 -6.90863 -2.19606</span></span>
<span><span class="co">#&gt;  26:    -262.58249: -2.42753 -2.60517 -6.90863 -2.19606</span></span>
<span><span class="co">#&gt;  27:    -262.58249: -2.42753 -2.60517 -6.90863 -2.19606</span></span>
<span></span>
<span><span class="co"># print output to terminal</span></span>
<span><span class="va">out</span></span>
<span><span class="co">#&gt; Dynamics integrated using  ABM  with  10  time-steps</span></span>
<span><span class="co">#&gt; Run time: Time difference of 2.322536 mins</span></span>
<span><span class="co">#&gt; Negative log-likelihood: -262.5825</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; EcoSim parameters:</span></span>
<span><span class="co">#&gt;                type QB   PB         B        EE   U</span></span>
<span><span class="co">#&gt; Consumer_1   hetero 10  4.0 0.7859555 0.8561942 0.2</span></span>
<span><span class="co">#&gt; Consumer_2   hetero  4  1.0 1.3010913 0.8725432 0.2</span></span>
<span><span class="co">#&gt; Predator_1   hetero  3  0.2 0.9674416 0.0000000 0.2</span></span>
<span><span class="co">#&gt; Predator_2   hetero  1  0.1 0.9246556 0.0000000 0.2</span></span>
<span><span class="co">#&gt; Producer       auto NA 90.0 0.1008427 0.9514173 0.2</span></span>
<span><span class="co">#&gt; Detritus   detritus NA  0.5 9.5704738 0.9255574 0.2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; EcoSim diet matrix:</span></span>
<span><span class="co">#&gt;             Predator</span></span>
<span><span class="co">#&gt; Prey         Consumer_1 Consumer_2 Predator_1 Predator_2 Producer Detritus</span></span>
<span><span class="co">#&gt;   Consumer_1        0.0        0.0        0.8        0.4        0        0</span></span>
<span><span class="co">#&gt;   Consumer_2        0.0        0.0        0.2        0.6        0        0</span></span>
<span><span class="co">#&gt;   Predator_1        0.0        0.0        0.0        0.0        0        0</span></span>
<span><span class="co">#&gt;   Predator_2        0.0        0.0        0.0        0.0        0        0</span></span>
<span><span class="co">#&gt;   Producer          0.9        0.3        0.0        0.0        0        0</span></span>
<span><span class="co">#&gt;   Detritus          0.1        0.7        0.0        0.0        0        0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; EcoSim vulnerability matrix:</span></span>
<span><span class="co">#&gt;             Predator</span></span>
<span><span class="co">#&gt; Prey         Consumer_1 Consumer_2 Predator_1 Predator_2 Producer Detritus</span></span>
<span><span class="co">#&gt;   Consumer_1          2          2          2          2       91        2</span></span>
<span><span class="co">#&gt;   Consumer_2          2          2          2          2       91        2</span></span>
<span><span class="co">#&gt;   Predator_1          2          2          2          2       91        2</span></span>
<span><span class="co">#&gt;   Predator_2          2          2          2          2       91        2</span></span>
<span><span class="co">#&gt;   Producer            2          2          2          2       91        2</span></span>
<span><span class="co">#&gt;   Detritus            2          2          2          2       91        2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: sdreport(.) result</span></span>
<span><span class="co">#&gt;           Estimate  Std. Error</span></span>
<span><span class="co">#&gt; logtau_i -2.427535   0.2049494</span></span>
<span><span class="co">#&gt; logtau_i -2.605169   0.3047519</span></span>
<span><span class="co">#&gt; logtau_i -6.908635 624.7201881</span></span>
<span><span class="co">#&gt; logtau_i -2.196062   0.2882175</span></span>
<span><span class="co">#&gt; Maximum gradient component: 0.0001702873</span></span></code></pre></div>
<p>Finally, we can extract elements from the fitted model, and plot them
easily using ggplot2 to compare them with known (simulated) values. This
exercise shows that EcoState can accurately estimate biomass trends:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract estimated biomass</span></span>
<span><span class="va">Bhat_ti</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">sdrep</span>, what<span class="op">=</span><span class="st">"Estimate"</span>, report<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span><span class="op">$</span><span class="va">B_ti</span></span>
<span><span class="va">Bse_ti</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">out</span><span class="op">$</span><span class="va">sdrep</span>, what<span class="op">=</span><span class="st">"Std. Error"</span>, report<span class="op">=</span><span class="cn">TRUE</span> <span class="op">)</span><span class="op">$</span><span class="va">B_ti</span></span>
<span></span>
<span><span class="co"># Reformat to long-form data frame for ggplot</span></span>
<span><span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">Bobs_ti</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">results</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span> <span class="va">results</span>, </span>
<span>                 <span class="st">"True"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">B_ti</span><span class="op">)</span>,</span>
<span>                 <span class="st">"Est"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">Bhat_ti</span><span class="op">)</span>,</span>
<span>                 <span class="st">"SE"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">as.vector</a></span><span class="op">(</span><span class="va">Bse_ti</span><span class="op">)</span> <span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot using ggplot</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Year</span><span class="op">)</span>, y<span class="op">=</span><span class="va">True</span><span class="op">)</span> <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">Taxon</span><span class="op">)</span>, scale<span class="op">=</span><span class="st">"free"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Year</span><span class="op">)</span>, y<span class="op">=</span><span class="va">Est</span><span class="op">)</span>, linetype<span class="op">=</span><span class="st">"dotted"</span> <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">Year</span><span class="op">)</span>, ymin<span class="op">=</span><span class="va">Est</span><span class="op">-</span><span class="va">SE</span>, ymax<span class="op">=</span><span class="va">Est</span><span class="op">+</span><span class="va">SE</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">0.2</span><span class="op">)</span>                </span></code></pre></div>
<p><img src="simulation_files/figure-html/unnamed-chunk-10-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="advanced-estimating-vulnerability-parameters">Advanced: estimating vulnerability parameters<a class="anchor" aria-label="anchor" href="#advanced-estimating-vulnerability-parameters"></a>
</h2>
<p>We can also explore estimating additional parameters. Here, we
explore estimating vulnerability:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Run model</span></span>
<span><span class="va">out0</span> <span class="op">=</span> <span class="fu"><a href="../reference/ecostate.html">ecostate</a></span><span class="op">(</span> taxa <span class="op">=</span> <span class="va">taxa</span>,</span>
<span>                years <span class="op">=</span> <span class="va">years</span>,</span>
<span>                catch <span class="op">=</span> <span class="va">Catch</span>,</span>
<span>                biomass <span class="op">=</span> <span class="va">Biomass</span>,</span>
<span>                PB <span class="op">=</span> <span class="va">PB_i</span>,</span>
<span>                QB <span class="op">=</span> <span class="va">QB_i</span>,</span>
<span>                DC <span class="op">=</span> <span class="va">DC_ij</span>,</span>
<span>                B <span class="op">=</span> <span class="va">fittedB_i</span>,</span>
<span>                EE <span class="op">=</span> <span class="va">fittedEE_i</span>,</span>
<span>                X <span class="op">=</span> <span class="va">X_ij</span>,</span>
<span>                type <span class="op">=</span> <span class="va">type_i</span>,</span>
<span>                U <span class="op">=</span> <span class="va">U_i</span>,</span>
<span>                fit_B <span class="op">=</span> <span class="va">fit_B</span>,</span>
<span>                fit_Q <span class="op">=</span> <span class="va">fit_Q</span>,</span>
<span>                fit_eps <span class="op">=</span> <span class="va">fit_eps</span>,</span>
<span>                fit_B0 <span class="op">=</span> <span class="va">fit_B0</span>,</span>
<span>                control <span class="op">=</span> <span class="fu"><a href="../reference/ecostate_control.html">ecostate_control</a></span><span class="op">(</span> inverse_method <span class="op">=</span> <span class="st">"Standard"</span>, </span>
<span>                                            nlminb_loops <span class="op">=</span> <span class="fl">0</span>,</span>
<span>                                            tmbad.sparse_hessian_compress <span class="op">=</span> <span class="fl">0</span>,  </span>
<span>                                            getsd <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                                            process_error <span class="op">=</span> <span class="st">"epsilon"</span>,</span>
<span>                                            profile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logF_ti"</span>,<span class="st">"logB_i"</span><span class="op">)</span>,</span>
<span>                                            start_tau <span class="op">=</span> <span class="fl">0.001</span> <span class="op">)</span><span class="op">)</span>   <span class="co"># alpha is faster than epsilon</span></span>
<span></span>
<span><span class="co"># Change tmb_par</span></span>
<span><span class="va">tmb_par</span> <span class="op">=</span> <span class="va">out0</span><span class="op">$</span><span class="va">tmb_inputs</span><span class="op">$</span><span class="va">p</span></span>
<span>  <span class="va">tmb_par</span><span class="op">$</span><span class="va">Xprime_ij</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">type_i</span><span class="op">!=</span><span class="st">"auto"</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1.5</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span> </span>
<span><span class="va">map</span> <span class="op">=</span> <span class="va">out0</span><span class="op">$</span><span class="va">tmb_inputs</span><span class="op">$</span><span class="va">map</span></span>
<span>  <span class="va">map</span><span class="op">$</span><span class="va">Xprime_ij</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html" class="external-link">array</a></span><span class="op">(</span><span class="cn">NA</span>, dim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">tmb_par</span><span class="op">$</span><span class="va">Xprime_ij</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">map</span><span class="op">$</span><span class="va">Xprime_ij</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">type_i</span><span class="op">!=</span><span class="st">"auto"</span><span class="op">)</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span></span>
<span>  <span class="va">map</span><span class="op">$</span><span class="va">Xprime_ij</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">map</span><span class="op">$</span><span class="va">Xprime_ij</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run model</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="../reference/ecostate.html">ecostate</a></span><span class="op">(</span> taxa <span class="op">=</span> <span class="va">taxa</span>,</span>
<span>                years <span class="op">=</span> <span class="va">years</span>,</span>
<span>                catch <span class="op">=</span> <span class="va">Catch</span>,</span>
<span>                biomass <span class="op">=</span> <span class="va">Biomass</span>,</span>
<span>                PB <span class="op">=</span> <span class="va">PB_i</span>,</span>
<span>                QB <span class="op">=</span> <span class="va">QB_i</span>,</span>
<span>                DC <span class="op">=</span> <span class="va">DC_ij</span>,</span>
<span>                B <span class="op">=</span> <span class="va">fittedB_i</span>,</span>
<span>                EE <span class="op">=</span> <span class="va">fittedEE_i</span>,</span>
<span>                X <span class="op">=</span> <span class="va">X_ij</span>,</span>
<span>                type <span class="op">=</span> <span class="va">type_i</span>,</span>
<span>                U <span class="op">=</span> <span class="va">U_i</span>,</span>
<span>                fit_B <span class="op">=</span> <span class="va">fit_B</span>,</span>
<span>                fit_Q <span class="op">=</span> <span class="va">fit_Q</span>,</span>
<span>                fit_eps <span class="op">=</span> <span class="va">fit_eps</span>,</span>
<span>                fit_B0 <span class="op">=</span> <span class="va">fit_B0</span>,</span>
<span>                control <span class="op">=</span> <span class="fu"><a href="../reference/ecostate_control.html">ecostate_control</a></span><span class="op">(</span> inverse_method <span class="op">=</span> <span class="st">"Standard"</span>, </span>
<span>                                            nlminb_loops <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                                            tmbad.sparse_hessian_compress <span class="op">=</span> <span class="fl">0</span>,  </span>
<span>                                            getsd <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                            process_error <span class="op">=</span> <span class="st">"epsilon"</span>,</span>
<span>                                            profile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"logF_ti"</span>,<span class="st">"logB_i"</span><span class="op">)</span>,</span>
<span>                                            start_tau <span class="op">=</span> <span class="fl">0.001</span>,</span>
<span>                                            tmb_par <span class="op">=</span> <span class="va">tmb_par</span>,</span>
<span>                                            map <span class="op">=</span> <span class="va">map</span> <span class="op">)</span><span class="op">)</span>   <span class="co"># alpha is faster than epsilon</span></span>
<span><span class="co">#&gt; Using `control$tmb_par`, so be cautious in constructing it</span></span>
<span><span class="co">#&gt; Using `control$map`, so be cautious in constructing it</span></span>
<span><span class="co">#&gt; Warning in nlminb(start = opt$par, objective = obj$fn, gradient = obj$gr, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in nlminb(start = opt$par, objective = obj$fn, gradient = obj$gr, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in nlminb(start = opt$par, objective = obj$fn, gradient = obj$gr, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span><span class="co">#&gt; Warning in nlminb(start = opt$par, objective = obj$fn, gradient = obj$gr, :</span></span>
<span><span class="co">#&gt; NA/NaN function evaluation</span></span>
<span></span>
<span><span class="co"># print output to terminal</span></span>
<span><span class="va">out</span></span>
<span><span class="co">#&gt; Dynamics integrated using  ABM  with  10  time-steps</span></span>
<span><span class="co">#&gt; Run time: Time difference of 7.133491 mins</span></span>
<span><span class="co">#&gt; Negative log-likelihood: -262.5825</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; EcoSim parameters:</span></span>
<span><span class="co">#&gt;                type QB   PB         B        EE   U</span></span>
<span><span class="co">#&gt; Consumer_1   hetero 10  4.0 0.7859487 0.8562777 0.2</span></span>
<span><span class="co">#&gt; Consumer_2   hetero  4  1.0 1.3011220 0.8726118 0.2</span></span>
<span><span class="co">#&gt; Predator_1   hetero  3  0.2 0.9675226 0.0000000 0.2</span></span>
<span><span class="co">#&gt; Predator_2   hetero  1  0.1 0.9247681 0.0000000 0.2</span></span>
<span><span class="co">#&gt; Producer       auto NA 90.0 0.1008435 0.9514061 0.2</span></span>
<span><span class="co">#&gt; Detritus   detritus NA  0.5 9.5704580 0.9255754 0.2</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; EcoSim diet matrix:</span></span>
<span><span class="co">#&gt;             Predator</span></span>
<span><span class="co">#&gt; Prey         Consumer_1 Consumer_2 Predator_1 Predator_2 Producer Detritus</span></span>
<span><span class="co">#&gt;   Consumer_1        0.0        0.0        0.8        0.4        0        0</span></span>
<span><span class="co">#&gt;   Consumer_2        0.0        0.0        0.2        0.6        0        0</span></span>
<span><span class="co">#&gt;   Predator_1        0.0        0.0        0.0        0.0        0        0</span></span>
<span><span class="co">#&gt;   Predator_2        0.0        0.0        0.0        0.0        0        0</span></span>
<span><span class="co">#&gt;   Producer          0.9        0.3        0.0        0.0        0        0</span></span>
<span><span class="co">#&gt;   Detritus          0.1        0.7        0.0        0.0        0        0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; EcoSim vulnerability matrix:</span></span>
<span><span class="co">#&gt;             Predator</span></span>
<span><span class="co">#&gt; Prey         Consumer_1 Consumer_2 Predator_1 Predator_2 Producer Detritus</span></span>
<span><span class="co">#&gt;   Consumer_1   1.999266   1.999266   1.999266   1.999266       91 1.999266</span></span>
<span><span class="co">#&gt;   Consumer_2   1.999266   1.999266   1.999266   1.999266       91 1.999266</span></span>
<span><span class="co">#&gt;   Predator_1   1.999266   1.999266   1.999266   1.999266       91 1.999266</span></span>
<span><span class="co">#&gt;   Predator_2   1.999266   1.999266   1.999266   1.999266       91 1.999266</span></span>
<span><span class="co">#&gt;   Producer     1.999266   1.999266   1.999266   1.999266       91 1.999266</span></span>
<span><span class="co">#&gt;   Detritus     1.999266   1.999266   1.999266   1.999266       91 1.999266</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Estimates: sdreport(.) result</span></span>
<span><span class="co">#&gt;                Estimate  Std. Error</span></span>
<span><span class="co">#&gt; Xprime_ij -0.0007346426   0.1769047</span></span>
<span><span class="co">#&gt; logtau_i  -2.4276318486   0.2064240</span></span>
<span><span class="co">#&gt; logtau_i  -2.6048038923   0.3155934</span></span>
<span><span class="co">#&gt; logtau_i  -6.9077525581 613.9936273</span></span>
<span><span class="co">#&gt; logtau_i  -2.1959829679   0.2887926</span></span>
<span><span class="co">#&gt; Maximum gradient component: 0.0001618803</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by James T. Thorson.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
